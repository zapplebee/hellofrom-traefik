version: "3.9"

#######################################################
#         T R A E F I K  &  E D G E                   #
#                                                     #
#  Start the traefik service and the blue deployment  #
#    docker compose --profile main up                 #
#                                                     #
#  Start the green deployment this will take higher   #
#  priority than the blue deployment                  #
#    docker compose --profile green up                #
#                                                     #
#  Stop the green profile and blue will take over     #
#  in priority                                        #
#    docker compose --profile green down              #
#                                                     #
#######################################################

services:
  traefik:
    image: traefik:v3.6.4
    container_name: traefik
    restart: unless-stopped

    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false

      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.websecure.address=:443

      - --api=true
      - --api.dashboard=true

      - --certificatesresolvers.le.acme.email=zskalko+hellofrom@gmail.com
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web

      - --log.level=INFO
      - --accesslog=true
      - --accesslog.format=json
      - --accesslog.fields.defaultmode=keep

      # headers: drop everything, then explicitly keep a few
      - --accesslog.fields.headers.defaultmode=drop
      - --accesslog.fields.headers.names.X-Forwarded-For=keep
      - --accesslog.fields.headers.names.X-Request-Id=keep
      - --accesslog.fields.headers.names.User-Agent=keep

      # keep router/service identity
      - --accesslog.fields.names.RouterName=keep
      - --accesslog.fields.names.ServiceName=keep
    ports:
      - "80:80"
      - "443:443"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik-letsencrypt:/letsencrypt

    networks:
      - hf_edge
      - hf_svc_keycloak
      - hf_svc_umami
      - hf_svc_openobserve
      - hf_svc_portainer
      - hf_svc_webapp

    labels:
      - traefik.enable=true
      - traefik.http.middlewares.hf-localonly.ipallowlist.sourcerange=127.0.0.1/32,::1/128,172.17.0.1/32,207.153.43.69/32

      - traefik.http.routers.traefik-ui.rule=Host(`traefik.hellofrom.app`)
      - traefik.http.routers.traefik-ui.entrypoints=websecure
      - traefik.http.routers.traefik-ui.tls=true
      - traefik.http.routers.traefik-ui.tls.certresolver=le
      - traefik.http.routers.traefik-ui.service=api@internal
      - traefik.http.routers.traefik-ui.middlewares=hf-localonly@docker

  portainer:
    image: portainer/portainer-ce:lts
    container_name: portainer
    restart: unless-stopped

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./portainer_data:/data

    networks:
      - hf_svc_portainer

    labels:
      - traefik.enable=true
      - traefik.http.routers.portainer.rule=Host(`portainer.hellofrom.app`)
      - traefik.http.routers.portainer.entrypoints=websecure
      - traefik.http.routers.portainer.tls=true
      - traefik.http.routers.portainer.tls.certresolver=le

      # your existing local-only rule
      - traefik.http.routers.portainer.middlewares=hf-localonly@docker

      # simplest: Traefik -> Portainer over HTTP (Portainer's legacy port)
      - traefik.http.services.portainer.loadbalancer.server.port=9000

  hellofrom_blue:
    image: oven/bun:1.3.3
    container_name: hellofrom_blue
    restart: unless-stopped

    working_dir: /app
    command: ["bun", "/app/index.js"]

    volumes:
      - ./index.blue.js:/app/index.js:ro

    environment:
      - COLOR=blue
      - NODE_ENV=prov
      - CDN_BASE=https://dev.hellofrom.pages.dev
      - ENABLE_TRACKING=1
      - ENABLE_CDN=1

    networks:
      - hf_svc_webapp
      - hf_svc_umami

    labels:
      - traefik.enable=true
      - traefik.docker.network=hf_svc_webapp
      - traefik.http.services.hellofrom-blue.loadbalancer.server.port=5173

      - traefik.http.middlewares.hf-color-blue.headers.customResponseHeaders.X-HF-Color=blue

      - traefik.http.routers.hellofrom-blue.rule=Host(`hellofrom.app`)
      - traefik.http.routers.hellofrom-blue.entrypoints=websecure
      - traefik.http.routers.hellofrom-blue.tls=true
      - traefik.http.routers.hellofrom-blue.tls.certresolver=le
      - traefik.http.routers.hellofrom-blue.priority=10
      - traefik.http.routers.hellofrom-blue.service=hellofrom-blue

  hellofrom_green:
    image: oven/bun:1.3.3
    container_name: hellofrom_green
    restart: unless-stopped
    profiles:
      - green

    working_dir: /app
    command: ["bun", "/app/index.js"]

    volumes:
      - ./index.blue.js:/app/index.js:ro

    environment:
      - COLOR=green
      - NODE_ENV=prov
      - CDN_BASE=https://dev.hellofrom.pages.dev
      - ENABLE_TRACKING=1
      - ENABLE_CDN=1

    networks:
      - hf_svc_webapp
      - hf_svc_umami

    labels:
      - traefik.enable=true
      - traefik.docker.network=hf_svc_webapp
      - traefik.http.services.hellofrom-green.loadbalancer.server.port=5173

      - traefik.http.middlewares.hf-color-green.headers.customResponseHeaders.X-HF-Color=green

      - traefik.http.routers.hellofrom-green.rule=Host(`hellofrom.app`)
      - traefik.http.routers.hellofrom-green.entrypoints=websecure
      - traefik.http.routers.hellofrom-green.tls=true
      - traefik.http.routers.hellofrom-green.tls.certresolver=le
      - traefik.http.routers.hellofrom-green.priority=100
      - traefik.http.routers.hellofrom-green.service=hellofrom-green

networks:
  hf_edge:
    name: hf_edge
    driver: bridge

  hf_svc_portainer:
    name: hf_svc_portainer
    driver: bridge

  hf_svc_webapp:
    name: hf_svc_webapp
    driver: bridge

  hf_svc_keycloak:
    name: hf_svc_keycloak
    driver: bridge
    internal: true

  hf_svc_umami:
    name: hf_svc_umami
    driver: bridge
    internal: true

  hf_svc_openobserve:
    name: hf_svc_openobserve
    driver: bridge
    internal: true
