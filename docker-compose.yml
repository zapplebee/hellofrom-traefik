version: "3.9"

services:
  traefik:
    image: traefik:v3.6.4
    container_name: traefik
    restart: unless-stopped

    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false

      - --providers.file.directory=/etc/traefik/dynamic/enabled
      - --providers.file.watch=true

      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.websecure.address=:443

      - --api=true
      - --api.dashboard=true

      - --certificatesresolvers.le.acme.email=zskalko+hellofrom@gmail.com
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web

      - --log.level=INFO
      - --accesslog=true

      - "--accesslog.format=json"
      - "--accesslog.fields.defaultmode=keep"
      - "--accesslog.fields.headers.defaultmode=drop"

      # Keep useful headers
      - "--accesslog.fields.headers.names.X-Forwarded-For=keep"
      - "--accesslog.fields.headers.names.X-Request-Id=keep"
      - "--accesslog.fields.headers.names.User-Agent=keep"

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik-letsencrypt:/letsencrypt
      # mount the full dynamic tree so /enabled exists
      - ./dynamic:/etc/traefik/dynamic:ro

    networks:
      - hf_edge
      - hf_svc_keycloak
      - hf_svc_umami
      - hf_svc_openobserve

    labels:
      - traefik.enable=true
      - traefik.http.middlewares.hf-localonly.ipallowlist.sourcerange=127.0.0.1/32,::1/128,172.17.0.1/32,207.153.43.69/32

      - traefik.http.routers.traefik-ui.rule=Host(`traefik.hellofrom.app`)
      - traefik.http.routers.traefik-ui.entrypoints=websecure
      - traefik.http.routers.traefik-ui.tls=true
      - traefik.http.routers.traefik-ui.tls.certresolver=le
      - traefik.http.routers.traefik-ui.service=api@internal
      - traefik.http.routers.traefik-ui.middlewares=hf-localonly@docker

  hellofrom_blue:
    image: oven/bun:1.3.3
    container_name: hellofrom_blue
    restart: unless-stopped

    working_dir: /app
    command: ["bun", "/app/index.js"]

    volumes:
      - ./index.blue.js:/app/index.js:ro

    environment:
      - COLOR=blue
      - NODE_ENV=prov
      - CDN_BASE=https://dev.hellofrom.pages.dev
      - ENABLE_TRACKING=1
      - ENABLE_CDN=1

    networks:
      - hf_edge
      - hf_svc_umami

    labels:
      - traefik.enable=true
      - traefik.http.services.hellofrom-blue.loadbalancer.server.port=5173

  hellofrom_green:
    image: oven/bun:1.3.3
    container_name: hellofrom_green
    restart: unless-stopped

    working_dir: /app
    command: ["bun", "/app/index.js"]

    volumes:
      - ./index.js:/app/index.js:ro

    environment:
      - COLOR=green
      - NODE_ENV=prov
      - CDN_BASE=https://dev.hellofrom.pages.dev

    networks:
      - hf_edge

    labels:
      - traefik.enable=true
      - traefik.http.services.hellofrom-green.loadbalancer.server.port=5173

networks:
  hf_edge:
    name: hf_edge
    driver: bridge

  hf_svc_keycloak:
    name: hf_svc_keycloak
    driver: bridge
    internal: true

  hf_svc_umami:
    name: hf_svc_umami
    driver: bridge
    internal: true

  hf_svc_openobserve:
    name: hf_svc_openobserve
    driver: bridge
    internal: true
